<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent 0 - Topic Research Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            padding: 40px;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .chart-container {
            position: relative;
            height: 600px;
            margin-bottom: 30px;
            background: #fafafa;
            border-radius: 8px;
            padding: 20px;
        }
        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 6px;
            border-left: 4px solid;
        }
        .legend-gold_mine { border-left-color: #4CAF50; }
        .legend-viable { border-left-color: #2196F3; }
        .legend-risky_niche { border-left-color: #FF9800; }
        .legend-avoid { border-left-color: #f44336; }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .legend-gold_mine .legend-color { background: rgba(76, 175, 80, 0.6); border: 2px solid #4CAF50; }
        .legend-viable .legend-color { background: rgba(33, 150, 243, 0.6); border: 2px solid #2196F3; }
        .legend-risky_niche .legend-color { background: rgba(255, 152, 0, 0.6); border: 2px solid #FF9800; }
        .legend-avoid .legend-color { background: rgba(244, 67, 54, 0.6); border: 2px solid #f44336; }
        .legend-text {
            flex: 1;
        }
        .legend-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }
        .legend-desc {
            font-size: 12px;
            color: #666;
        }
        .selection-panel {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }
        .selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .selected-count {
            font-size: 16px;
            color: #333;
        }
        .selected-count strong {
            color: #667eea;
        }
        .button-group {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .btn-secondary {
            background: #4CAF50;
            color: white;
        }
        .btn-secondary:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
        .btn-clear {
            background: #f44336;
            color: white;
        }
        .btn-clear:hover {
            background: #da190b;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .selected-topics-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .topic-chip {
            display: inline-flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        .topic-chip-primary {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #333;
            border: 2px solid #FFD700;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
        }
        .topic-chip-backup {
            background: #e0e0e0;
            color: #333;
            border: 2px solid #bdbdbd;
        }
        .topic-chip-badge {
            margin-left: 8px;
            font-size: 11px;
            font-weight: 700;
        }
        .instructions {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 30px;
        }
        .instructions h3 {
            color: #1976D2;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .instructions ul {
            margin-left: 20px;
            color: #555;
        }
        .instructions li {
            margin-bottom: 5px;
        }
        .rate-limit-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 12px 18px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            font-size: 13px;
            min-width: 180px;
        }
        .rate-limit-header {
            font-weight: 600;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .rate-limit-status {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .rate-limit-safe { color: #4CAF50; }
        .rate-limit-caution { color: #FF9800; }
        .rate-limit-danger { color: #f44336; }
        .rate-limit-details {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }
        .rate-limit-cache {
            font-size: 11px;
            color: #2196F3;
            margin-top: 4px;
        }
        .breadcrumb-container {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }
        .breadcrumb-trail {
            font-size: 16px;
            color: #333;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        .breadcrumb-icon {
            margin-right: 8px;
            font-size: 18px;
        }
        .crumb-link {
            color: #667eea;
            cursor: pointer;
            transition: all 0.2s;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .crumb-link:hover {
            background: rgba(102, 126, 234, 0.1);
            text-decoration: underline;
        }
        .crumb-separator {
            margin: 0 8px;
            color: #999;
        }
        .crumb-current {
            font-weight: 600;
            color: #333;
        }
        .rule-badge {
            display: inline-block;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #333;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            margin-left: 10px;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
        }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
            text-align: center;
            color: #999;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- Rate Limit Indicator (Top Right) -->
    <div class="rate-limit-indicator" id="rateLimitIndicator">
        <div class="rate-limit-header">
            <span id="rateLimitIcon">📊</span>
            <span>API Status</span>
        </div>
        <div class="rate-limit-status" id="rateLimitStatus">Loading...</div>
        <div class="rate-limit-details" id="rateLimitDetails"></div>
        <div class="rate-limit-cache" id="rateLimitCache"></div>
    </div>

    <div class="container">
        <h1>🎯 Topic Research Dashboard</h1>
        <p class="subtitle">Agent 0 - Purchase Intent Analysis | Generated: 2025-10-24 01:28:45</p>

        <div class="legend">
            <div class="legend-item legend-gold_mine">
                <div class="legend-color"></div>
                <div class="legend-text">
                    <div class="legend-title">🟢 GOLD MINE</div>
                    <div class="legend-desc">High Demand + Low Competition</div>
                </div>
            </div>
            <div class="legend-item legend-viable">
                <div class="legend-color"></div>
                <div class="legend-text">
                    <div class="legend-title">🔵 VIABLE</div>
                    <div class="legend-desc">High Demand + High Competition</div>
                </div>
            </div>
            <div class="legend-item legend-risky_niche">
                <div class="legend-color"></div>
                <div class="legend-text">
                    <div class="legend-title">🟡 RISKY NICHE</div>
                    <div class="legend-desc">Low Demand + Low Competition</div>
                </div>
            </div>
            <div class="legend-item legend-avoid">
                <div class="legend-color"></div>
                <div class="legend-text">
                    <div class="legend-title">🔴 AVOID</div>
                    <div class="legend-desc">Low Demand + High Competition</div>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="demandCompetitionChart"></canvas>
        </div>

        <div class="breadcrumb-container">
            <div class="breadcrumb-trail" id="breadcrumb-trail">
                <span class="breadcrumb-icon">🏠</span>
                <span class="crumb-current">All Topics (1)</span>
            </div>
        </div>

        <div class="selection-panel">
            <div class="selection-header">
                <div class="selected-count">
                    <strong>Primary:</strong> <span id="primary-count">None</span> |
                    <strong>Backup:</strong> <span id="backup-count">0</span> topics
                </div>
                <div class="button-group">
                    <button id="drill-down-btn" class="btn btn-primary" disabled>
                        🔍 Drill Down
                    </button>
                    <button id="export-primary-btn" class="btn btn-primary" disabled>
                        Export Primary (JSON)
                    </button>
                    <button id="export-all-btn" class="btn btn-secondary" disabled>
                        Export All (CSV)
                    </button>
                    <button id="clear-btn" class="btn btn-clear">
                        Clear Selection
                    </button>
                </div>
            </div>
            <div id="selected-list" class="selected-topics-list"></div>
        </div>

        <div class="instructions">
            <h3>📊 How to Use This Dashboard</h3>
            <ul>
                <li><strong>Click once</strong> on a bubble to select it as your <strong>PRIMARY</strong> topic (gold highlight)</li>
                <li><strong>Shift+Click</strong> on bubbles to add them to your <strong>BACKUP</strong> list (red highlight)</li>
                <li><strong>Bubble position</strong> shows demand vs competition (top-left = gold mine!)</li>
                <li><strong>Bubble size</strong> shows total audience reach (bigger = more people)</li>
                <li>Export your selections using the buttons above</li>
            </ul>
        </div>

        <div class="footer">
            <p>Purchase Intent System - Agent 0: Topic Research Agent</p>
            <p>LED Range: 500-599 | Data sources: Google Trends, Reddit, YouTube</p>
        </div>
    </div>

    <script>
        // API call history injection (for rate limit indicator)
        // API call history for rate limit indicator
        try {
            localStorage.setItem('agent0_api_calls', '[{"timestamp": 1761288221699.2478, "keyword": "billionaire romance novels", "cached": false, "source": "google_trends", "datetime": "2025-10-24T00:43:41.699247"}, {"timestamp": 1761288249060.9385, "keyword": "paranormal romance novels", "cached": false, "source": "google_trends", "datetime": "2025-10-24T00:44:09.060938"}, {"timestamp": 1761288261996.128, "keyword": "historical regency romance", "cached": false, "source": "google_trends", "datetime": "2025-10-24T00:44:21.996127"}, {"timestamp": 1761288274988.264, "keyword": "contemporary romance novels", "cached": false, "source": "google_trends", "datetime": "2025-10-24T00:44:34.988264"}, {"timestamp": 1761288287904.7676, "keyword": "enemies to lovers romance", "cached": false, "source": "google_trends", "datetime": "2025-10-24T00:44:47.904767"}, {"timestamp": 1761288356826.8716, "keyword": "small town romance", "cached": false, "source": "google_trends", "datetime": "2025-10-24T00:45:56.826871"}, {"timestamp": 1761288369761.1484, "keyword": "sports romance novels", "cached": false, "source": "google_trends", "datetime": "2025-10-24T00:46:09.761148"}, {"timestamp": 1761288382757.5857, "keyword": "military romance novels", "cached": false, "source": "google_trends", "datetime": "2025-10-24T00:46:22.757585"}]');
        } catch (e) {
            console.warn('Failed to save API history to localStorage:', e);
        }

        // Topic data from Python
        const topicsData = [
        {
                "topic": "romance novels",
                "demand": 62.0,
                "competition": 45.3,
                "opportunity": 33.91,
                "audience_size": 6522063,
                "zone": "gold_mine",
                "confidence": 70,
                "richness_stars": 3,
                "richness_score": 57.94,
                "richness_breakdown": {
                        "reddit": {
                                "richness": 81.8,
                                "total_posts": 50,
                                "avg_engagement": 4773.74
                        },
                        "youtube": {
                                "richness": 34.1,
                                "total_videos": 19,
                                "avg_views": 330704.0
                        }
                },
                "recency_score": 34.52,
                "recency_data": {
                        "recency_score": 34.52,
                        "recent_activity_pct": 27.5,
                        "trend_momentum": "no_data",
                        "avg_content_age_days": 491.5,
                        "recent_30_days": 9,
                        "recent_90_days": 19,
                        "total_content": 69
                }
        }
];

        // Selection state
        let primaryTopic = null;
        let backupTopics = [];

        // Zone colors
        const zoneColors = {
            gold_mine: {
                bg: 'rgba(76, 175, 80, 0.6)',
                border: '#4CAF50'
            },
            viable: {
                bg: 'rgba(33, 150, 243, 0.6)',
                border: '#2196F3'
            },
            risky_niche: {
                bg: 'rgba(255, 152, 0, 0.6)',
                border: '#FF9800'
            },
            avoid: {
                bg: 'rgba(244, 67, 54, 0.6)',
                border: '#f44336'
            }
        };

        // Prepare chart data
        const chartDatasets = topicsData.map(topic => ({
            label: topic.topic,
            data: [{
                x: topic.competition,
                y: topic.demand,
                r: Math.sqrt(topic.audience_size / 100000) + 5  // Size scaling
            }],
            backgroundColor: zoneColors[topic.zone].bg,
            borderColor: zoneColors[topic.zone].border,
            borderWidth: 2,
            topicData: topic
        }));

        // Plugin to draw richness number inside bubbles
        const centerTextPlugin = {
            id: 'centerText',
            afterDatasetsDraw(chart) {
                const ctx = chart.ctx;
                chart.data.datasets.forEach((dataset, i) => {
                    const meta = chart.getDatasetMeta(i);
                    if (!meta.hidden) {
                        meta.data.forEach((element) => {
                            const richness = dataset.topicData.richness_stars;
                            const {x, y} = element.getCenterPoint();

                            // White number with drop shadow for maximum contrast
                            ctx.save();

                            // Draw drop shadow for better visibility
                            ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                            ctx.shadowBlur = 4;
                            ctx.shadowOffsetX = 2;
                            ctx.shadowOffsetY = 2;

                            ctx.font = 'bold 20px Arial';
                            ctx.fillStyle = 'white';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(richness, x, y);
                            ctx.restore();
                        });
                    }
                });
            }
        };

        // Plugin to draw clock-ring recency visualization around bubbles
        const clockRingPlugin = {
            id: 'clockRing',
            afterDatasetsDraw(chart) {
                const ctx = chart.ctx;
                chart.data.datasets.forEach((dataset, i) => {
                    const meta = chart.getDatasetMeta(i);
                    if (!meta.hidden) {
                        meta.data.forEach((element) => {
                            const recencyScore = dataset.topicData.recency_score || 0;
                            const {x, y} = element.getCenterPoint();
                            const radius = element.options.radius + 3; // Ring outside bubble
                            const ringWidth = 5.5;

                            // Calculate fill percentage (0-100 maps to 0-360 degrees)
                            const fillAngle = (recencyScore / 100) * 2 * Math.PI;

                            ctx.save();
                            ctx.lineWidth = ringWidth;

                            // Draw empty ring (20% opacity purple) - full circle
                            ctx.beginPath();
                            ctx.arc(x, y, radius, 0, 2 * Math.PI);
                            ctx.strokeStyle = 'rgba(124, 77, 255, 0.2)';
                            ctx.stroke();

                            // Draw filled arc (solid purple) - from 12 o'clock clockwise
                            if (fillAngle > 0) {
                                ctx.beginPath();
                                // Start at -90 degrees (12 o'clock) and go clockwise
                                ctx.arc(x, y, radius, -Math.PI / 2, -Math.PI / 2 + fillAngle);
                                ctx.strokeStyle = '#7C4DFF';
                                ctx.stroke();
                            }

                            ctx.restore();
                        });
                    }
                });
            }
        };

        // Create chart
        const ctx = document.getElementById('demandCompetitionChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'bubble',
            data: {
                datasets: chartDatasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const topic = context.dataset.topicData;
                                const stars = '⭐'.repeat(topic.richness_stars);
                                const breakdown = topic.richness_breakdown;
                                const recency = topic.recency_data || {};

                                let lines = [
                                    `Topic: ${topic.topic}`,
                                    `Demand: ${topic.demand.toFixed(1)}/100`,
                                    `Competition: ${topic.competition.toFixed(1)}/100`,
                                    `Opportunity: ${topic.opportunity.toFixed(1)}/100`,
                                    `Audience: ${topic.audience_size.toLocaleString()}`,
                                    ``,
                                    `Data Richness: ${stars} (${topic.richness_stars}/5)`
                                ];

                                // Add breakdown if available
                                if (breakdown.trends) {
                                    lines.push(`├─ Trends: ${breakdown.trends.data_points} pts : ${breakdown.trends.average_interest.toFixed(1)} interest`);
                                }
                                if (breakdown.reddit) {
                                    lines.push(`├─ Reddit: ${breakdown.reddit.total_posts} posts : ${breakdown.reddit.avg_engagement.toFixed(0)} engage`);
                                }
                                if (breakdown.youtube) {
                                    lines.push(`└─ YouTube: ${breakdown.youtube.total_videos} videos : ${breakdown.youtube.avg_views.toLocaleString()} views`);
                                }

                                // Add recency information (NEW)
                                if (recency.recency_score !== undefined) {
                                    lines.push(``);
                                    lines.push(`Recency/Urgency: ${recency.recency_score.toFixed(1)}/100`);
                                    if (recency.recent_90_days > 0) {
                                        lines.push(`├─ Recent Activity: ${recency.recent_activity_pct.toFixed(1)}% in 90d`);
                                        lines.push(`├─ Last 30 days: ${recency.recent_30_days} items`);
                                        lines.push(`├─ Trend: ${recency.trend_momentum}`);
                                        lines.push(`└─ Avg Age: ${recency.avg_content_age_days.toFixed(0)} days`);
                                    }
                                }

                                lines.push(``);
                                lines.push(`Zone: ${topic.zone.replace('_', ' ').toUpperCase()}`);

                                return lines;
                            }
                        }
                    },
                    annotation: {
                        annotations: {
                            verticalLine: {
                                type: 'line',
                                xMin: 50,
                                xMax: 50,
                                borderColor: 'rgba(0, 0, 0, 0.3)',
                                borderWidth: 2,
                                borderDash: [5, 5]
                            },
                            horizontalLine: {
                                type: 'line',
                                yMin: 50,
                                yMax: 50,
                                borderColor: 'rgba(0, 0, 0, 0.3)',
                                borderWidth: 2,
                                borderDash: [5, 5]
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Competition Level →',
                            font: { size: 14, weight: 'bold' }
                        },
                        min: 0,
                        max: 100,
                        ticks: { stepSize: 10 }
                    },
                    y: {
                        title: {
                            display: true,
                            text: '↑ Demand Score',
                            font: { size: 14, weight: 'bold' }
                        },
                        min: 0,
                        max: 100,
                        ticks: { stepSize: 10 }
                    }
                },
                onClick: (event, activeElements) => {
                    if (activeElements.length > 0) {
                        const index = activeElements[0].datasetIndex;
                        const topic = chartDatasets[index].topicData;

                        // Check if shift key is pressed
                        if (event.native.shiftKey) {
                            toggleBackup(index, topic);
                        } else {
                            setPrimary(index, topic);
                        }

                        updateChart();
                        updateSelectionDisplay();
                    }
                }
            },
            plugins: [clockRingPlugin, centerTextPlugin]  // Clock ring first (background), then text (foreground)
        });

        // Selection functions
        function setPrimary(index, topic) {
            // If this topic is in backup, remove it from backup first
            const backupIndex = backupTopics.findIndex(b => b.index === index);
            if (backupIndex >= 0) {
                backupTopics.splice(backupIndex, 1);
            }

            primaryTopic = { index, topic };

            // Update chart styling
            chartDatasets.forEach((dataset, i) => {
                if (i === index) {
                    dataset.borderColor = '#FFD700';
                    dataset.borderWidth = 4;
                } else if (!isBackup(i)) {
                    dataset.borderColor = zoneColors[dataset.topicData.zone].border;
                    dataset.borderWidth = 2;
                }
            });
        }

        function toggleBackup(index, topic) {
            // If this is the primary topic, don't allow it to be backup
            if (primaryTopic && primaryTopic.index === index) {
                return;  // Do nothing
            }

            const existingIndex = backupTopics.findIndex(b => b.index === index);

            if (existingIndex >= 0) {
                // Remove from backup
                backupTopics.splice(existingIndex, 1);
                chartDatasets[index].borderColor = zoneColors[topic.zone].border;
                chartDatasets[index].borderWidth = 2;
            } else {
                // Add to backup with red border
                backupTopics.push({ index, topic });
                chartDatasets[index].borderColor = '#f44336';
                chartDatasets[index].borderWidth = 5;
            }
        }

        function isBackup(index) {
            return backupTopics.some(b => b.index === index);
        }

        function updateChart() {
            chart.update();
        }

        function updateSelectionDisplay() {
            // Update counts
            document.getElementById('primary-count').textContent =
                primaryTopic ? primaryTopic.topic.topic : 'None';
            document.getElementById('backup-count').textContent = backupTopics.length;

            // Update chips
            const listDiv = document.getElementById('selected-list');
            listDiv.innerHTML = '';

            if (primaryTopic) {
                const chip = document.createElement('div');
                chip.className = 'topic-chip topic-chip-primary';
                chip.innerHTML = `${primaryTopic.topic.topic} <span class="topic-chip-badge">⭐ PRIMARY</span>`;
                listDiv.appendChild(chip);
            }

            backupTopics.forEach(backup => {
                const chip = document.createElement('div');
                chip.className = 'topic-chip topic-chip-backup';
                chip.innerHTML = `${backup.topic.topic} <span class="topic-chip-badge">💾 BACKUP</span>`;
                listDiv.appendChild(chip);
            });

            // Enable/disable buttons
            document.getElementById('drill-down-btn').disabled = !primaryTopic;
            document.getElementById('export-primary-btn').disabled = !primaryTopic;
            document.getElementById('export-all-btn').disabled = !primaryTopic && backupTopics.length === 0;
        }

        // Drill-down button (placeholder - will be implemented in next phase)
        document.getElementById('drill-down-btn').addEventListener('click', () => {
            if (!primaryTopic) return;

            alert('🔍 Drill-down feature coming soon!\n\nThis will analyze 15-20 specific sub-niches of "' +
                  primaryTopic.topic.topic + '" to help you find the "Rule of One" specific topic.');
        });

        // Export functions
        document.getElementById('export-primary-btn').addEventListener('click', () => {
            if (!primaryTopic) return;

            const exportData = {
                selected_topic: primaryTopic.topic.topic,
                demand_score: primaryTopic.topic.demand,
                competition_score: primaryTopic.topic.competition,
                opportunity_score: primaryTopic.topic.opportunity,
                zone: primaryTopic.topic.zone,
                audience_size: primaryTopic.topic.audience_size,
                confidence: primaryTopic.topic.confidence,
                timestamp: new Date().toISOString(),
                agent: "Agent0_TopicResearch"
            };

            downloadJSON(exportData, 'topic-selection.json');
        });

        document.getElementById('export-all-btn').addEventListener('click', () => {
            const allTopics = [];

            if (primaryTopic) {
                allTopics.push({
                    selection: 'PRIMARY',
                    ...primaryTopic.topic
                });
            }

            backupTopics.forEach(backup => {
                allTopics.push({
                    selection: 'BACKUP',
                    ...backup.topic
                });
            });

            downloadCSV(allTopics, 'topic-analysis.csv');
        });

        document.getElementById('clear-btn').addEventListener('click', () => {
            primaryTopic = null;
            backupTopics = [];

            chartDatasets.forEach(dataset => {
                dataset.borderColor = zoneColors[dataset.topicData.zone].border;
                dataset.borderWidth = 2;
            });

            updateChart();
            updateSelectionDisplay();
        });

        // Rate Limit Indicator - Track API usage and display status
        function updateRateLimitIndicator() {
            const now = Date.now();
            const oneHourAgo = now - (60 * 60 * 1000);

            // Get API call history from localStorage
            let apiCalls = [];
            try {
                const stored = localStorage.getItem('agent0_api_calls');
                if (stored) {
                    apiCalls = JSON.parse(stored);
                    // Filter to last hour only
                    apiCalls = apiCalls.filter(call => call.timestamp > oneHourAgo);
                }
            } catch (e) {
                console.warn('Failed to read API call history:', e);
            }

            // Count calls and cache hits
            const totalCalls = apiCalls.length;
            const cacheHits = apiCalls.filter(call => call.cached).length;
            const actualApiCalls = totalCalls - cacheHits;
            const cacheHitRate = totalCalls > 0 ? (cacheHits / totalCalls * 100) : 0;

            // Calculate next safe query time
            const lastCall = apiCalls.length > 0 ? Math.max(...apiCalls.map(c => c.timestamp)) : 0;
            const timeSinceLastCall = (now - lastCall) / 1000; // seconds
            const minDelay = 12; // 12 seconds between queries
            const nextSafeTime = Math.max(0, minDelay - timeSinceLastCall);

            // Determine status (based on actual API calls per hour)
            let status, statusClass, icon;
            const maxCallsPerHour = 15;

            if (actualApiCalls <= 5) {
                status = '🟢 SAFE';
                statusClass = 'rate-limit-safe';
                icon = '✅';
            } else if (actualApiCalls <= 10) {
                status = '🟡 CAUTION';
                statusClass = 'rate-limit-caution';
                icon = '⚠️';
            } else {
                status = '🔴 DANGER';
                statusClass = 'rate-limit-danger';
                icon = '🚫';
            }

            // Update UI
            document.getElementById('rateLimitIcon').textContent = icon;
            document.getElementById('rateLimitStatus').textContent = status;
            document.getElementById('rateLimitStatus').className = 'rate-limit-status ' + statusClass;

            document.getElementById('rateLimitDetails').textContent =
                `${actualApiCalls}/${maxCallsPerHour} API calls last hour` +
                (nextSafeTime > 0 ? ` | Next safe: ${Math.ceil(nextSafeTime)}s` : '');

            document.getElementById('rateLimitCache').textContent =
                `Cache: ${cacheHits}/${totalCalls} hits (${cacheHitRate.toFixed(0)}%)`;
        }

        // Initialize rate limit indicator on page load
        updateRateLimitIndicator();
        // Update every 5 seconds
        setInterval(updateRateLimitIndicator, 5000);

        // Download helpers
        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }

        function downloadCSV(data, filename) {
            const headers = ['Selection', 'Topic', 'Demand', 'Competition', 'Opportunity', 'Zone', 'Audience_Size', 'Confidence'];
            const rows = data.map(d => [
                d.selection,
                d.topic,
                d.demand.toFixed(2),
                d.competition.toFixed(2),
                d.opportunity.toFixed(2),
                d.zone,
                d.audience_size,
                d.confidence
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }
    </script>
</body>
</html>