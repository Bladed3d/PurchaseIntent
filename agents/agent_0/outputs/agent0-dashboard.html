<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent 0 - Topic Research Dashboard (Split View)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .split-container {
            display: grid;
            grid-template-columns: 40% 60%;
            height: 100vh;
            gap: 0;
        }

        /* LEFT PANEL - Tree Navigation */
        .tree-panel {
            background: white;
            overflow-y: auto;
            border-right: 3px solid #667eea;
            box-shadow: 4px 0 12px rgba(0,0,0,0.1);
        }

        .tree-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .tree-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .tree-header .subtitle {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 5px;
        }

        .tree-content {
            padding: 20px;
        }

        .tree-node {
            margin: 8px 0;
            padding-left: 0;
        }

        .tree-node.level-1 { padding-left: 20px; }
        .tree-node.level-2 { padding-left: 40px; }
        .tree-node.level-3 { padding-left: 60px; }

        .node-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: #f9f9f9;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid #e0e0e0;
            margin-bottom: 8px;
        }

        .node-checkbox {
            margin-right: 10px;
            cursor: pointer;
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .node-item:hover {
            background: #e3f2fd;
            border-left-color: #2196F3;
            transform: translateX(4px);
        }

        .node-item.selected {
            background: linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%);
            border-left-color: #667eea;
            font-weight: 600;
        }

        .node-item.gold-mine { border-left-color: #4CAF50; }
        .node-item.viable { border-left-color: #2196F3; }
        .node-item.risky { border-left-color: #FF9800; }
        .node-item.avoid { border-left-color: #f44336; }

        .node-icon {
            margin-right: 10px;
            font-size: 16px;
        }

        .node-text {
            flex: 1;
            font-size: 14px;
        }

        .node-score {
            font-weight: bold;
            font-size: 13px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .node-score.gold-mine { background: #C8E6C9; color: #2E7D32; }
        .node-score.viable { background: #BBDEFB; color: #1565C0; }
        .node-score.risky { background: #FFE0B2; color: #E65100; }
        .node-score.avoid { background: #FFCDD2; color: #C62828; }

        .toggle-btn {
            cursor: pointer;
            margin-right: 8px;
            font-size: 12px;
            color: #666;
            user-select: none;
        }

        .tree-children {
            display: none;
        }

        .tree-children.expanded {
            display: block;
        }

        /* RIGHT PANEL - Chart */
        .chart-panel {
            background: white;
            overflow-y: auto;
        }

        .chart-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .chart-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .chart-header .subtitle {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 5px;
        }

        .chart-container {
            position: relative;
            height: 700px;
            margin: 20px;
            background: #fafafa;
            border-radius: 8px;
            padding: 15px;
        }

        .info-popup {
            display: none;
            position: fixed;
            background: white;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            max-width: 700px;
            max-height: 85vh;
            z-index: 1000;
        }

        .info-popup.active {
            display: block;
        }

        .info-popup h3 {
            margin: 0 0 15px 0;
            color: #667eea;
        }

        .info-popup .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 24px;
            color: #999;
        }

        .info-popup .close-btn:hover {
            color: #333;
        }

        .info-section {
            margin: 10px 0;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
        }

        .info-section strong {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="split-container">
        <!-- LEFT PANEL: Tree Navigation -->
        <div class="tree-panel">
            <div class="tree-header">
                <h2>ðŸŒ³ Topic Hierarchy</h2>
                <div class="subtitle">Click to explore, expand to drill down</div>
            </div>
            <div class="tree-content">
                
            <div class="tree-node level-0">
                <div class="node-item unknown" data-node-id="test_topic_2025-10-31T13:59:52.071546">
                    <input type="checkbox" id="check-test_topic_2025-10-31T13:59:52.071546" class="node-checkbox" checked onchange="toggleTopicSelection('test_topic_2025-10-31T13:59:52.071546')" onclick="event.stopPropagation()">
                    
                    <span class="node-icon" onclick="selectNode('test_topic_2025-10-31T13:59:52.071546')">ðŸŽ¯</span>
                    <span class="node-text" onclick="selectNode('test_topic_2025-10-31T13:59:52.071546')">test topic</span>
                    <span class="node-score unknown" onclick="selectNode('test_topic_2025-10-31T13:59:52.071546')">93.6</span>
                </div>
            </div>
            </div>
        </div>

        <!-- RIGHT PANEL: Chart -->
        <div class="chart-panel">
            <div class="chart-header">
                <h2>ðŸ“Š Demand vs Competition</h2>
                <div class="subtitle">Hover bubbles for details â€¢ Generated: 2025-10-31 13:59:52</div>
            </div>
            <div class="chart-container">
                <canvas id="topicChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Info Popup -->
    <div class="info-popup" id="infoPopup">
        <span class="close-btn" onclick="closePopup()">&times;</span>
        <div id="popupContent"></div>
    </div>

    <script>
        // Data
        const allTopics = [{"topic": "test topic", "scores": {"composite_score": 93.6, "trends_score": 87.2, "reddit_score": 100.0, "confidence": 100, "sources_with_data": 2, "competition": {"trends_competition": 20, "reddit_competition": 51.5, "overall_competition": 35.75, "competition_level": "moderate", "competition_emoji": "\ud83d\udfe1", "competition_description": "MODERATE"}, "opportunity": {"opportunity_score": 60.14, "recommendation": "high_priority", "recommendation_emoji": "\ud83d\udfe2", "recommendation_description": "HIGH PRIORITY - Strong demand, low competition", "risk_level": "LOW", "complexity": "MODERATE", "complexity_description": "Standard ebook approach works", "demand_score": 93.59960000000001, "competition_score": 35.75}, "insights": ["\u2705 Strong validated demand", "\ud83d\udfe1 Moderate competition - differentiation needed", "\u2705 Rising trend - early mover advantage", "\u2705 Active community with strong engagement", "\u2705 High engagement suggests purchase intent"], "audience_size": 10645116, "zone": "gold_mine", "richness": {"richness_score": 92.0, "richness_stars": 5, "sources_count": 2, "breakdown": {"trends": {"richness": 84.0, "data_points": 53, "average_interest": 66.06}, "reddit": {"richness": 100, "total_posts": 50, "avg_engagement": 7361.16}}}, "recency": {"recency_score": 48.0, "recent_activity_pct": 30.0, "trend_momentum": "rising", "avg_content_age_days": 500.9, "recent_30_days": 3, "recent_90_days": 15, "total_content": 50}}, "trends_data": {"average_interest": 66.06, "peak_interest": 100.0, "trend_direction": "rising", "data_points": 53}, "reddit_data": {"total_posts": 50, "total_engagement": 368058, "avg_engagement": 7361.16, "top_subreddits": [{"name": "ChatGPT", "count": 3}, {"name": "BestofRedditorUpdates", "count": 3}, {"name": "AmItheAsshole", "count": 3}, {"name": "todayilearned", "count": 2}, {"name": "AITAH", "count": 2}], "timestamps": [1561542500.0, 1403801293.0, 1708352655.0, 1584724618.0, 1695656430.0, 1753419063.0, 1733821638.0, 1754925690.0, 1756699322.0, 1747345158.0, 1753185498.0, 1671478185.0, 1721302200.0, 1755806357.0, 1756544624.0, 1723566327.0, 1754515920.0, 1749556777.0, 1754499518.0, 1750367115.0, 1742363043.0, 1705614819.0, 1736030414.0, 1713912218.0, 1724243773.0, 1758491688.0, 1619133455.0, 1742723838.0, 1756883610.0, 1759863539.0, 1748051556.0, 1738854120.0, 1719369981.0, 1675564237.0, 1757079137.0, 1675696912.0, 1758547495.0, 1753228396.0, 1757874880.0, 1700435669.0, 1679656728.0, 1747942589.0, 1741536973.0, 1757606081.0, 1753197229.0, 1761189144.0, 1714258112.0, 1667070992.0, 1761614585.0, 1714048542.0]}, "purchase_intent": {"purchase_intent_score": 33.06, "willingness_to_pay_score": 62.0, "keyword_matches": {"buy": 0, "worth": 11, "recommend": 22, "price": 5, "pay": 12, "comparison": 6, "question": 2}, "price_mentions": [649.74, 856.17, 85.0, 30.0, 70.0, 10.0], "price_range": [10.0, 856.17], "avg_price": 283.48499999999996, "problem_frequency": 4.0, "repeated_questions": 2, "monetization_signals": 37, "monetization_types": ["ad"], "purchase_signals": ["\u2705 11 posts ask if it's worth it", "\u2705 12 posts discuss paid/subscription options", "\u2705 22 posts request recommendations", "\ud83d\udcb0 6 price mentions ($10-$856, avg $283)", "\ud83d\udcb5 37 posts show existing monetization (ad)", "\u2696\ufe0f 6 posts compare options (active decision-making)"], "total_analyzed": 50}}];
        const treeData = {"version": "1.0", "created": "2025-10-31T13:59:52.071546", "last_updated": "2025-10-31T13:59:52.075074", "root_nodes": [{"id": "test_topic_2025-10-31T13:59:52.071546", "topic": "test topic", "score": 93.6, "level": 0, "researched_at": "2025-10-31T13:59:52.071546", "output_file": "outputs\\topic-selection.json", "data": {"topic": "test topic", "scores": {"composite_score": 93.6, "trends_score": 87.2, "reddit_score": 100.0, "confidence": 100, "sources_with_data": 2, "competition": {"trends_competition": 20, "reddit_competition": 51.5, "overall_competition": 35.75, "competition_level": "moderate", "competition_emoji": "\ud83d\udfe1", "competition_description": "MODERATE"}, "opportunity": {"opportunity_score": 60.14, "recommendation": "high_priority", "recommendation_emoji": "\ud83d\udfe2", "recommendation_description": "HIGH PRIORITY - Strong demand, low competition", "risk_level": "LOW", "complexity": "MODERATE", "complexity_description": "Standard ebook approach works", "demand_score": 93.59960000000001, "competition_score": 35.75}, "insights": ["\u2705 Strong validated demand", "\ud83d\udfe1 Moderate competition - differentiation needed", "\u2705 Rising trend - early mover advantage", "\u2705 Active community with strong engagement", "\u2705 High engagement suggests purchase intent"], "audience_size": 10645116, "zone": "gold_mine", "richness": {"richness_score": 92.0, "richness_stars": 5, "sources_count": 2, "breakdown": {"trends": {"richness": 84.0, "data_points": 53, "average_interest": 66.06}, "reddit": {"richness": 100, "total_posts": 50, "avg_engagement": 7361.16}}}, "recency": {"recency_score": 48.0, "recent_activity_pct": 30.0, "trend_momentum": "rising", "avg_content_age_days": 500.9, "recent_30_days": 3, "recent_90_days": 15, "total_content": 50}}, "trends_data": {"average_interest": 66.06, "peak_interest": 100.0, "trend_direction": "rising", "data_points": 53}, "reddit_data": {"total_posts": 50, "total_engagement": 368058, "avg_engagement": 7361.16, "top_subreddits": [{"name": "ChatGPT", "count": 3}, {"name": "BestofRedditorUpdates", "count": 3}, {"name": "AmItheAsshole", "count": 3}, {"name": "todayilearned", "count": 2}, {"name": "AITAH", "count": 2}], "timestamps": [1561542500.0, 1403801293.0, 1708352655.0, 1584724618.0, 1695656430.0, 1753419063.0, 1733821638.0, 1754925690.0, 1756699322.0, 1747345158.0, 1753185498.0, 1671478185.0, 1721302200.0, 1755806357.0, 1756544624.0, 1723566327.0, 1754515920.0, 1749556777.0, 1754499518.0, 1750367115.0, 1742363043.0, 1705614819.0, 1736030414.0, 1713912218.0, 1724243773.0, 1758491688.0, 1619133455.0, 1742723838.0, 1756883610.0, 1759863539.0, 1748051556.0, 1738854120.0, 1719369981.0, 1675564237.0, 1757079137.0, 1675696912.0, 1758547495.0, 1753228396.0, 1757874880.0, 1700435669.0, 1679656728.0, 1747942589.0, 1741536973.0, 1757606081.0, 1753197229.0, 1761189144.0, 1714258112.0, 1667070992.0, 1761614585.0, 1714048542.0]}, "purchase_intent": {"purchase_intent_score": 33.06, "willingness_to_pay_score": 62.0, "keyword_matches": {"buy": 0, "worth": 11, "recommend": 22, "price": 5, "pay": 12, "comparison": 6, "question": 2}, "price_mentions": [649.74, 856.17, 85.0, 30.0, 70.0, 10.0], "price_range": [10.0, 856.17], "avg_price": 283.48499999999996, "problem_frequency": 4.0, "repeated_questions": 2, "monetization_signals": 37, "monetization_types": ["ad"], "purchase_signals": ["\u2705 11 posts ask if it's worth it", "\u2705 12 posts discuss paid/subscription options", "\u2705 22 posts request recommendations", "\ud83d\udcb0 6 price mentions ($10-$856, avg $283)", "\ud83d\udcb5 37 posts show existing monetization (ad)", "\u2696\ufe0f 6 posts compare options (active decision-making)"], "total_analyzed": 50}}, "children": []}]};

        let currentChart = null;
        let selectedTopics = new Set();

        // Plugin to draw richness number inside bubbles
        const centerTextPlugin = {
            id: 'centerText',
            afterDatasetsDraw(chart) {
                const ctx = chart.ctx;
                chart.data.datasets.forEach((dataset, i) => {
                    const meta = chart.getDatasetMeta(i);
                    if (!meta.hidden) {
                        meta.data.forEach((element) => {
                            const topicData = dataset.topicData;
                            const richness = topicData?.richness?.richness_stars || topicData?.richness_stars || 5;
                            const {x, y} = element.getCenterPoint();

                            // White number with drop shadow for maximum contrast
                            ctx.save();

                            // Draw drop shadow for better visibility
                            ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                            ctx.shadowBlur = 4;
                            ctx.shadowOffsetX = 2;
                            ctx.shadowOffsetY = 2;

                            ctx.font = 'bold 20px Arial';
                            ctx.fillStyle = 'white';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(richness, x, y);
                            ctx.restore();
                        });
                    }
                });
            }
        };

        // Plugin to draw clock-ring recency visualization around bubbles
        const clockRingPlugin = {
            id: 'clockRing',
            afterDatasetsDraw(chart) {
                const ctx = chart.ctx;
                chart.data.datasets.forEach((dataset, i) => {
                    const meta = chart.getDatasetMeta(i);
                    if (!meta.hidden) {
                        meta.data.forEach((element) => {
                            const topicData = dataset.topicData;
                            const recencyScore = topicData?.recency?.recency_score || topicData?.recency_score || 0;
                            const {x, y} = element.getCenterPoint();
                            const radius = element.options.radius + 3; // Ring outside bubble
                            const ringWidth = 5.5;

                            // Calculate fill percentage (0-100 maps to 0-360 degrees)
                            const fillAngle = (recencyScore / 100) * 2 * Math.PI;

                            ctx.save();
                            ctx.lineWidth = ringWidth;

                            // Draw empty ring (20% opacity purple) - full circle
                            ctx.beginPath();
                            ctx.arc(x, y, radius, 0, 2 * Math.PI);
                            ctx.strokeStyle = 'rgba(124, 77, 255, 0.2)';
                            ctx.stroke();

                            // Draw filled arc (solid purple) - from 12 o'clock clockwise
                            if (fillAngle > 0) {
                                ctx.beginPath();
                                // Start at -90 degrees (12 o'clock) and go clockwise
                                ctx.arc(x, y, radius, -Math.PI / 2, -Math.PI / 2 + fillAngle);
                                ctx.strokeStyle = '#7C4DFF';
                                ctx.stroke();
                            }

                            ctx.restore();
                        });
                    }
                });
            }
        };

        // Initialize
        window.addEventListener('load', () => {
            collectAllNodeIds(treeData.root_nodes);
            updateChartFromSelection();
        });

        function collectAllNodeIds(nodes) {
            if (!nodes) return;
            for (const node of nodes) {
                selectedTopics.add(node.id);
                if (node.children) {
                    collectAllNodeIds(node.children);
                }
            }
        }

        function toggleTopicSelection(nodeId) {
            const checkbox = document.getElementById(`check-${nodeId}`);
            const isChecked = checkbox.checked;

            // Update this node
            if (isChecked) {
                selectedTopics.add(nodeId);
            } else {
                selectedTopics.delete(nodeId);
            }

            // Find node and cascade to children
            const node = findNodeById(treeData.root_nodes, nodeId);
            if (node && node.children) {
                cascadeCheckboxes(node.children, isChecked);
            }

            updateChartFromSelection();
        }

        function cascadeCheckboxes(nodes, checked) {
            if (!nodes) return;
            for (const node of nodes) {
                const childCheckbox = document.getElementById(`check-${node.id}`);
                if (childCheckbox) {
                    childCheckbox.checked = checked;
                    if (checked) {
                        selectedTopics.add(node.id);
                    } else {
                        selectedTopics.delete(node.id);
                    }
                }
                if (node.children) {
                    cascadeCheckboxes(node.children, checked);
                }
            }
        }

        function updateChartFromSelection() {
            const topicsToShow = [];
            for (const nodeId of selectedTopics) {
                const node = findNodeById(treeData.root_nodes, nodeId);
                if (node && node.data) {
                    topicsToShow.push(node.data);
                }
            }
            // Show only checked topics (empty array = no bubbles if nothing checked)
            updateChart(topicsToShow);
        }

        function selectNode(nodeId) {
            const node = findNodeById(treeData.root_nodes, nodeId);
            if (!node) return;

            document.querySelectorAll('.node-item').forEach(el => el.classList.remove('selected'));
            const selectedEl = document.querySelector(`[data-node-id="${nodeId}"]`);
            if (selectedEl) selectedEl.classList.add('selected');

            let topicsToShow = [];
            if (node.children && node.children.length > 0) {
                topicsToShow = node.children.map(child => child.data);
            } else {
                topicsToShow = [node.data];
            }

            updateChart(topicsToShow);
        }

        function findNodeById(nodes, id) {
            if (!nodes) return null;
            for (const node of nodes) {
                if (node.id === id) return node;
                if (node.children) {
                    const found = findNodeById(node.children, id);
                    if (found) return found;
                }
            }
            return null;
        }

        function toggleChildren(nodeId) {
            const childrenDiv = document.getElementById(`children-${nodeId}`);
            const toggleBtn = document.getElementById(`toggle-${nodeId}`);
            if (childrenDiv) {
                const isExpanded = childrenDiv.classList.toggle('expanded');
                if (toggleBtn) {
                    toggleBtn.textContent = isExpanded ? 'â–¼' : 'â–¶';
                }
            }
        }

        function showInfo(topicData) {
            const popup = document.getElementById('infoPopup');
            const content = document.getElementById('popupContent');

            const scores = topicData.scores || {};
            const aiDesc = topicData.ai_description || topicData.description || scores.ai_description || "No description available";
            const demandScore = scores.opportunity?.demand_score || scores.composite_score || 0;
            const compScore = scores.opportunity?.competition_score || scores.competition?.overall_competition || 0;
            const opportunityScore = scores.opportunity?.opportunity_score || 0;
            const category = scores.opportunity?.recommendation || scores.zone || 'Unknown';
            const audienceSize = scores.audience_size || 0;
            const insights = scores.insights || [];

            // Reddit data
            const redditData = topicData.reddit_data || {};
            const topSubreddits = redditData.top_subreddits || [];

            // Purchase intent data
            const purchaseIntent = topicData.purchase_intent || {};
            const intentScore = purchaseIntent.purchase_intent_score || 0;
            const willingnessScore = purchaseIntent.willingness_to_pay_score || 0;
            const purchaseSignals = purchaseIntent.purchase_signals || [];
            const priceRange = purchaseIntent.price_range || null;
            const avgPrice = purchaseIntent.avg_price || 0;

            // Build insights HTML
            const insightsHTML = insights.length > 0
                ? insights.map(insight => `<div style="margin: 4px 0;">${insight}</div>`).join('')
                : '<div style="color: #999;">No insights available</div>';

            // Build Reddit communities HTML with clickable links
            const redditHTML = topSubreddits.length > 0
                ? topSubreddits.map(sub => `
                    <div style="padding: 8px; background: #f5f5f5; border-radius: 4px; margin: 4px 0;">
                        <a href="https://reddit.com/r/${sub.name}" target="_blank" style="color: #667eea; text-decoration: none;">
                            r/${sub.name}
                        </a> - ${sub.count} members
                    </div>
                `).join('')
                : '<div style="color: #999; padding: 8px;">No Reddit data available</div>';


            content.innerHTML = `
                <div style="max-height: calc(85vh - 100px); overflow-y: auto; padding-right: 8px;">
                    <h3 style="margin: 0 0 12px 0; color: #667eea;">${topicData.topic}</h3>

                    <div style="background: #e8f5e9; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                        <div style="font-weight: 600; font-size: 18px;">Score: ${scores.composite_score?.toFixed(1) || 'N/A'}</div>
                    </div>

                    <div style="margin-bottom: 16px; padding: 12px; background: #f9f9f9; border-radius: 6px; border-left: 3px solid #667eea;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: #667eea;">AI Description:</div>
                        <div style="font-size: 14px; line-height: 1.6; color: #333;">
                            ${aiDesc}
                        </div>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center;">
                            <span style="margin-right: 6px;">ðŸ“Š</span> Key Insights
                        </div>
                        <div style="font-size: 14px; line-height: 1.6;">
                            ${insightsHTML}
                        </div>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center;">
                            <span style="margin-right: 6px;">ðŸ“ˆ</span> Metrics
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px;">
                            <div style="padding: 12px; background: #f5f5f5; border-radius: 6px; border-left: 3px solid #667eea;">
                                <div style="font-size: 12px; color: #666;">Demand Score</div>
                                <div style="font-size: 20px; font-weight: 600;">${demandScore.toFixed(1)}</div>
                            </div>
                            <div style="padding: 12px; background: #f5f5f5; border-radius: 6px; border-left: 3px solid #ff9800;">
                                <div style="font-size: 12px; color: #666;">Competition</div>
                                <div style="font-size: 20px; font-weight: 600;">${compScore.toFixed(1)}</div>
                            </div>
                            <div style="padding: 12px; background: #f5f5f5; border-radius: 6px; border-left: 3px solid #4caf50;">
                                <div style="font-size: 12px; color: #666;">Opportunity</div>
                                <div style="font-size: 20px; font-weight: 600;">${opportunityScore.toFixed(1)}</div>
                            </div>
                        </div>
                        <div style="padding: 12px; background: #f5f5f5; border-radius: 6px;">
                            <div style="font-size: 12px; color: #666;">Audience Size</div>
                            <div style="font-size: 18px; font-weight: 600;">${audienceSize.toLocaleString()}</div>
                        </div>
                    </div>

                    ${intentScore > 0 ? `
                    <div style="margin-bottom: 16px; padding: 12px; background: #fff3e0; border-radius: 6px; border-left: 3px solid #ff9800;">
                        <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center;">
                            <span style="margin-right: 6px;">ðŸ’°</span> Purchase Intent Analysis
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                            <div style="padding: 8px; background: white; border-radius: 4px;">
                                <div style="font-size: 11px; color: #666; text-transform: uppercase;">Purchase Intent</div>
                                <div style="font-size: 24px; font-weight: 600; color: #ff9800;">${intentScore.toFixed(0)}<span style="font-size: 14px; color: #999;">/100</span></div>
                            </div>
                            <div style="padding: 8px; background: white; border-radius: 4px;">
                                <div style="font-size: 11px; color: #666; text-transform: uppercase;">Willingness to Pay</div>
                                <div style="font-size: 24px; font-weight: 600; color: #4caf50;">${willingnessScore.toFixed(0)}<span style="font-size: 14px; color: #999;">/100</span></div>
                            </div>
                        </div>
                        ${priceRange ? `
                        <div style="padding: 8px; background: white; border-radius: 4px; margin-bottom: 8px;">
                            <div style="font-size: 11px; color: #666;">Price Range Mentioned</div>
                            <div style="font-size: 16px; font-weight: 500;">$$${priceRange[0].toFixed(0)} - $$${priceRange[1].toFixed(0)} <span style="color: #999; font-size: 12px;">(avg $$${avgPrice.toFixed(0)})</span></div>
                        </div>
                        ` : ''}
                        ${purchaseSignals.length > 0 ? `
                        <div style="font-size: 13px; line-height: 1.6; color: #555;">
                            ${purchaseSignals.map(signal => `<div style="margin: 4px 0; padding-left: 8px; border-left: 2px solid #ff9800;">${signal}</div>`).join('')}
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}

                    <div style="margin-bottom: 8px;">
                        <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center;">
                            <span style="margin-right: 6px;">ðŸ”¥</span> Top Reddit Communities
                        </div>
                        <div>
                            ${redditHTML}
                        </div>
                    </div>
                </div>
            `;

            popup.classList.add('active');
            popup.style.left = '50%';
            popup.style.top = '50%';
            popup.style.transform = 'translate(-50%, -50%)';
        }

        function closePopup() {
            document.getElementById('infoPopup').classList.remove('active');
        }

        function showTopicSummary(nodeId) {
            const node = findNodeById(treeData.root_nodes, nodeId);
            if (!node || !node.data) return;

            showInfo(node.data);
        }

        function updateChart(topics) {
            const ctx = document.getElementById('topicChart');
            if (!ctx) return;

            // Zone color mapping
            const zoneColors = {
                gold_mine: { bg: 'rgba(76, 175, 80, 0.6)', border: '#4CAF50' },
                viable: { bg: 'rgba(33, 150, 243, 0.6)', border: '#2196F3' },
                risky_niche: { bg: 'rgba(255, 152, 0, 0.6)', border: '#FF9800' },
                risky: { bg: 'rgba(255, 152, 0, 0.6)', border: '#FF9800' },
                avoid: { bg: 'rgba(244, 67, 54, 0.6)', border: '#f44336' }
            };

            // Create one dataset per topic with flattened data structure
            const datasets = topics.map(topicData => {
                const scores = topicData.scores || {};
                const zone = scores.zone || scores.opportunity?.recommendation || 'viable';
                const colors = zoneColors[zone] || zoneColors.viable;

                // Flatten data for plugins
                const flatTopic = {
                    topic: topicData.topic,
                    demand: scores.composite_score || 0,
                    competition: scores.competition?.overall_competition || scores.opportunity?.competition_score || 0,
                    opportunity: scores.opportunity?.opportunity_score || 0,
                    audience_size: scores.audience_size || 0,
                    zone: zone,
                    confidence: scores.confidence || 100,
                    richness_stars: scores.richness?.richness_stars || 5,
                    richness_score: scores.richness?.richness_score || 100,
                    richness_breakdown: scores.richness?.breakdown || {},
                    recency_score: scores.recency?.recency_score || 0,
                    recency_data: scores.recency || {}
                };

                return {
                    label: flatTopic.topic,
                    data: [{
                        x: flatTopic.competition,
                        y: flatTopic.demand,
                        r: Math.sqrt(flatTopic.audience_size / 100000) + 15  // Bubble size scales with audience
                    }],
                    backgroundColor: colors.bg,
                    borderColor: colors.border,
                    borderWidth: 3,
                    topicData: flatTopic
                };
            });

            if (currentChart) {
                currentChart.destroy();
            }

            currentChart = new Chart(ctx, {
                type: 'bubble',
                data: { datasets },
                plugins: [centerTextPlugin, clockRingPlugin],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const datasetIndex = elements[0].datasetIndex;
                            showInfo(topics[datasetIndex]);
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const topic = context.dataset.topicData;
                                    const stars = 'â­'.repeat(topic.richness_stars);
                                    const breakdown = topic.richness_breakdown || {};
                                    const recency = topic.recency_data || {};

                                    let lines = [
                                        `Topic: ${topic.topic}`,
                                        `Demand: ${topic.demand.toFixed(1)}/100`,
                                        `Competition: ${topic.competition.toFixed(1)}/100`,
                                        `Opportunity: ${topic.opportunity.toFixed(1)}/100`,
                                        `Audience: ${topic.audience_size.toLocaleString()}`,
                                        ``,
                                        `Data Richness: ${stars} (${topic.richness_stars}/5)`
                                    ];

                                    // Add breakdown if available
                                    if (breakdown.trends) {
                                        lines.push(`â”œâ”€ Trends: ${breakdown.trends.data_points} pts : ${breakdown.trends.average_interest.toFixed(1)} interest`);
                                    }
                                    if (breakdown.reddit) {
                                        lines.push(`â””â”€ Reddit: ${breakdown.reddit.total_posts} posts : ${breakdown.reddit.avg_engagement.toFixed(0)} engage`);
                                    }

                                    // Add recency information
                                    if (recency.recency_score !== undefined) {
                                        lines.push(``);
                                        lines.push(`Recency/Urgency: ${recency.recency_score.toFixed(1)}/100`);
                                        if (recency.recent_90_days > 0) {
                                            lines.push(`â”œâ”€ Recent Activity: ${recency.recent_activity_pct.toFixed(1)}% in 90d`);
                                            lines.push(`â”œâ”€ Last 30 days: ${recency.recent_30_days} items`);
                                            lines.push(`â”œâ”€ Trend: ${recency.trend_momentum}`);
                                            lines.push(`â””â”€ Avg Age: ${recency.avg_content_age_days.toFixed(0)} days`);
                                        }
                                    }

                                    lines.push(``);
                                    lines.push(`Zone: ${topic.zone.replace('_', ' ').toUpperCase()}`);

                                    return lines;
                                }
                            }
                        },
                        legend: { display: false },
                        annotation: {
                            annotations: {
                                verticalLine: {
                                    type: 'line',
                                    xMin: 50,
                                    xMax: 50,
                                    borderColor: 'rgba(0, 0, 0, 0.3)',
                                    borderWidth: 2,
                                    borderDash: [5, 5]
                                },
                                horizontalLine: {
                                    type: 'line',
                                    yMin: 50,
                                    yMax: 50,
                                    borderColor: 'rgba(0, 0, 0, 0.3)',
                                    borderWidth: 2,
                                    borderDash: [5, 5]
                                }
                            }
                        },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                    speed: 0.1
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'xy'
                            },
                            pan: {
                                enabled: true,
                                mode: 'xy'
                            },
                            limits: {
                                x: {min: 0, max: 120},
                                y: {min: 0, max: 120}
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Competition Level â†’',
                                font: { size: 14, weight: 'bold' }
                            },
                            min: 0,
                            max: 120,
                            ticks: {
                                stepSize: 10,
                                callback: function(value) {
                                    if (value > 100) return '';
                                    return Math.round(value);
                                }
                            },
                            grid: {
                                color: function(context) {
                                    return context.tick.value <= 100 ? 'rgba(0, 0, 0, 0.1)' : 'transparent';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Demand Score â†‘',
                                font: { size: 14, weight: 'bold' }
                            },
                            min: 0,
                            max: 120,
                            ticks: {
                                stepSize: 10,
                                callback: function(value) {
                                    if (value > 100) return '';
                                    return Math.round(value);
                                }
                            },
                            grid: {
                                color: function(context) {
                                    return context.tick.value <= 100 ? 'rgba(0, 0, 0, 0.1)' : 'transparent';
                                }
                            }
                        }
                    }
                }
            });
        }

        function getColorForCategory(category) {
            const colors = {
                'gold-mine': 'rgba(76, 175, 80, 0.6)',
                'viable': 'rgba(33, 150, 243, 0.6)',
                'risky': 'rgba(255, 152, 0, 0.6)',
                'avoid': 'rgba(244, 67, 54, 0.6)'
            };
            return colors[category] || 'rgba(158, 158, 158, 0.6)';
        }
    </script>
</body>
</html>